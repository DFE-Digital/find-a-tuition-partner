@page
@model SearchResults
@{
    ViewData["Title"] = "Search results";
}

<a href="/which-subjects?@Model.Data.ToQueryString()" class="govuk-back-link">Back</a>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        <govuk-error-summary>
            <govuk-error-summary-item asp-for="Data.Postcode" />
            <govuk-error-summary-item asp-for="Data.Subjects" />
            <govuk-error-summary-item asp-for="Data.TuitionType" />
        </govuk-error-summary>

        <h1 class="govuk-heading-l">
            <span class="app-results-filter--desktop">Find a tuition partner</span>
            <span class="app-results-filter--non-desktop">Search results</span>
        </h1>

    </div>
</div>

<div class="govuk-grid-row">

    <form>

        <div class="govuk-grid-column-one-third">
            <div class="app-results-filter" data-module="results-filter">
                <div class="app-results-filter-overlay--not-visible">
                    <h2 class="govuk-heading-m">Filter results</h2>
                </div>
                <div class="app-results-filter-overlay--visible">
                    <div class="app-results-filter-overlay--heading">
                        <div class="app-results-filter-overlay--heading-left">
                            <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">Filters</h1>
                        </div>
                        <div class="app-results-filter-overlay--heading-right">
                            <a href="/search-results?@Model.Data.ToQueryString()" class="govuk-link govuk-link--no-underline" data-module="return-to-results-link">Return to results</a>
                        </div>
                    </div>
                    <p show-if="Model.Data.Results != null" class="govuk-body">
                        @{
                            var count = Model.Data.Results!.Count == 0 ? "No" : Model.Data.Results.Count.ToString();
                            var resultPlural = Model.Data.Results.Count != 1 ? "results" : "result";
                        }
                        <span>@count @resultPlural</span>
                    </p>
                    <h2 class="govuk-heading-m">Subjects</h2>
                </div>

                @foreach (var item in Model.Data.AllSubjects.Keys)
                {
                    <partial name="_OptionsSelect" model="@(new OptionsSelectModel(
						item.ToString().ToSeoUrl(),
						item.DisplayName(),
						Model.Data.AllSubjects[item].Select(x => ($"{item}-{x.Name}".ToSeoUrl(), $"{item}-{x.Name}", x.Name, x.Selected)).OrderBy(x=> x.Name)
						)) " />
                }

                <govuk-radios asp-for="Data.TuitionType" class="govuk-radios--small govuk-!-margin-bottom-3">
                    <govuk-radios-fieldset>
                        <govuk-radios-fieldset-legend class="govuk-fieldset__legend--s">
                            Type of tuition
                        </govuk-radios-fieldset-legend>
                        @foreach (var item in Model.Data.AllTuitionTypes)
                        {
                            <govuk-radios-item id="@item.ToString().ToSeoUrl()" value="@item" checked="@item == @Model.Data.TuitionType">@item.DisplayName()</govuk-radios-item>
                        }
                    </govuk-radios-fieldset>
                </govuk-radios>

                <a asp-page-handler="ClearAllFilters" data-testid="clear-all-filters" class="govuk-link govuk-link--no-underline" asp-route-postcode=@Model.Data.Postcode>Clear all filters</a>
                
                <div class="govuk-!-margin-top-7">
                    <div class="govuk-button-group app-results-filter--apply-filters">
                        <govuk-button type="submit">Apply filters</govuk-button>
                    </div>
                    <div class="govuk-button-group app-results-filter-overlay--visible" data-module="overlay-apply-filters">
                        <govuk-button type="submit">Show search results</govuk-button>
                    </div>
                </div>
            </div>

            <div class="govuk-button-group app-results-filter-overlay--show-filters" data-module="show-filters-button-group">
                <govuk-button class="govuk-button--secondary">Show filters</govuk-button>
            </div>
        </div>

        <div class="govuk-grid-column-two-thirds">

            <div class="govuk-form-group app-form-group-inline">
                <div asp-validation-group-for="Data.Postcode" data-testid="postcode">
                    <label asp-for="Data.Postcode" class="govuk-label govuk-label--s">
                        Enter your school's postcode
                    </label>
                    <span asp-validation-for="Data.Postcode" class="govuk-error-message"></span>
                    <input asp-for="Data.Postcode" class="govuk-input" data-testid="postcode-input-box" type="text">
                    <govuk-button type="submit" data-testid="call-to-action">Search</govuk-button>
                </div>
            </div>

            <div show-if="Model.Data.Results != null" class="govuk-body" data-testid="results-summary">
                <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                @{
                    var count = Model.Data.Results!.Count == 0 ? "No" : Model.Data.Results.Count.ToString();
                    var resultPlural = Model.Data.Results.Count != 1 ? "results" : "result";
                }
                <span class="govuk-!-font-size-24"><strong>@count</strong> @(resultPlural) <span show-if="@Model.Data.LocalAuthority != null">for <strong>@Model.Data.LocalAuthority</strong></span></span><br />
                Your results are in a random order.
                <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
            </div>


            @if (Model.Data.Results != null)
            {
                foreach (var item in Model.Data.Results.Results)
                {
                    <div data-testid="results-list-item">
                        <h2 class="govuk-heading-m"><a asp-page="TuitionPartner" asp-route-id="@item.SeoUrl" class="govuk-link">@item.Name</a></h2>
                        <govuk-summary-list>
                            <govuk-summary-list-row class="govuk-body-s">
                                <govuk-summary-list-row-key>
                                    Subjects covered
                                </govuk-summary-list-row-key>
                                <govuk-summary-list-row-value>
                                    <ul class="govuk-list govuk-body-s govuk-list-bullets-mobile-view">
                                        @foreach (var keyStageSubjects in item.Subjects.GroupBy(e => e.KeyStageId))
                                        {
                                            <li>@(((KeyStage)keyStageSubjects.Key).DisplayName()) - @keyStageSubjects.DisplayList()</li>
                                        }
                                    </ul>
                                </govuk-summary-list-row-value>
                            </govuk-summary-list-row>
                            <govuk-summary-list-row class="govuk-body-s">
                                <govuk-summary-list-row-key>
                                    Type of tuition
                                </govuk-summary-list-row-key>
                                <govuk-summary-list-row-value>
                                    @string.Join(", ", item.TuitionTypes.Select(e => e.Name))
                                </govuk-summary-list-row-value>
                            </govuk-summary-list-row>
                            <govuk-summary-list-row class="govuk-body-s">
                                <govuk-summary-list-row-key>
                                    Tuition partner information
                                </govuk-summary-list-row-key>
                                <govuk-summary-list-row-value>
                                    @item.Description
                                </govuk-summary-list-row-value>
                            </govuk-summary-list-row>
                        </govuk-summary-list>
                    </div>
                }
            }
        </div>

    </form>
</div>