@page
@model SearchResults
@{
    ViewData["Title"] = "Search results";
}

<a href="/which-subjects?@Model.Data.ToQueryString()" class="govuk-back-link">Back</a>

<div class="govuk-grid-row">
	<div class="govuk-grid-column-full">
		
		<govuk-error-summary>
			<govuk-error-summary-item asp-for="Data.Postcode" />
			<govuk-error-summary-item asp-for="Data.Subjects" />
			<govuk-error-summary-item asp-for="Data.TuitionType" />
		</govuk-error-summary>
		
		<h1 class="govuk-heading-l">Find a tuition partner</h1>

	</div>
</div>

<div class="govuk-grid-row">
	
	<form>

		<div class="govuk-grid-column-one-third">
			<div class="app-results-filter" data-module="results-filter">
				<h2 class="govuk-heading-m">Filter results</h2>

				@foreach (var item in Model.Data.AllSubjects.Keys)
				{
					var forceOpenAllSubjectFilters = Model.Data.ForceOpenAllSubjectFilters;

					<partial name="_OptionsSelect" model="@(new OptionsSelectModel(
						item.ToString().ToSeoUrl(),
						item.DisplayName(),
						Model.Data.AllSubjects[item].Select(x => ($"{item}-{x.Name}".ToSeoUrl(), $"{item}-{x.Name}", x.Name, x.Selected)).OrderBy(x=> x.Name),
						ClosedOnLoad: forceOpenAllSubjectFilters
						)) "/>
				}
				
				<govuk-radios asp-for="Data.TuitionType" class="govuk-radios--small">
					<govuk-radios-fieldset>
						<govuk-radios-fieldset-legend class="govuk-fieldset__legend--s">
							Type of tuition
						</govuk-radios-fieldset-legend>
						@foreach (var item in Model.Data.AllTuitionTypes)
						{
							<govuk-radios-item id="@item.ToString().ToSeoUrl()" value="@item" checked="@item == @Model.Data.TuitionType">@item.DisplayName()</govuk-radios-item>
						}
					</govuk-radios-fieldset>
				</govuk-radios>

				<div class="govuk-button-group" data-module="results-filter-button">
					<govuk-button type="submit">Apply filters</govuk-button>
				</div>
			</div>
		</div>

		<div class="govuk-grid-column-two-thirds">

			<div class="govuk-form-group">
				<div asp-validation-group-for="Data.Postcode" data-testid="postcode">
					<label asp-for="Data.Postcode" class="govuk-label govuk-label--s">
						Enter your school's postcode
					</label>
					<span asp-validation-for="Data.Postcode" class="govuk-error-message"></span>
					<input asp-for="Data.Postcode" class="govuk-input govuk-input--width-10" type="text">
					<govuk-button type="submit" class="govuk-!-display-inline govuk-!-margin-0" data-testid="call-to-action">Search</govuk-button>
				</div>
			</div>

			<div show-if="Model.Data.Results != null" class="govuk-body" data-testid="results-summary">
				<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
				@{
					var count = Model.Data.Results!.Count == 0 ? "No" : Model.Data.Results.Count.ToString();
					var resultPlural = Model.Data.Results.Count != 1 ? "results" : "result";
				}
				<span class="govuk-!-font-size-24"><strong>@count</strong> @(resultPlural) <span show-if="@Model.Data.LocalAuthority != null">for <strong>@Model.Data.LocalAuthority</strong>.</span></span><br/>
				Your results are in a random order.
				<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
			</div>


			@if (Model.Data.Results != null)
			{
				foreach (var item in Model.Data.Results.Results)
				{
					<div data-testid="results-list-item">
						<h2 class="govuk-heading-m"><a asp-page="TuitionPartner" asp-route-id="@item.SeoUrl" class="govuk-link">@item.Name</a></h2>
						<govuk-summary-list>
							<govuk-summary-list-row class="govuk-body-s">
								<govuk-summary-list-row-key>
									Subjects covered
								</govuk-summary-list-row-key>
								<govuk-summary-list-row-value>
									<ul class="govuk-list govuk-body-s">
									@foreach (var keyStageSubjects in item.Subjects.GroupBy(e => e.KeyStageId))
									{
										<li>@(((KeyStage)keyStageSubjects.Key).DisplayName()) - @keyStageSubjects.DisplayList()</li>
									}
									</ul>
								</govuk-summary-list-row-value>
							</govuk-summary-list-row>
							<govuk-summary-list-row class="govuk-body-s">
								<govuk-summary-list-row-key>
									Type of tuition
								</govuk-summary-list-row-key>
								<govuk-summary-list-row-value>
									@string.Join(", ", item.TuitionTypes.Select(e => e.Name))
								</govuk-summary-list-row-value>
							</govuk-summary-list-row>
							<govuk-summary-list-row class="govuk-body-s">
								<govuk-summary-list-row-key>
									SEND support
								</govuk-summary-list-row-key>
								<govuk-summary-list-row-value>
									@item.HasSenProvision.ToYesNoString()
								</govuk-summary-list-row-value>
							</govuk-summary-list-row>
							<govuk-summary-list-row class="govuk-body-s">
								<govuk-summary-list-row-key>
									Provider information
								</govuk-summary-list-row-key>
								<govuk-summary-list-row-value>
									@item.Description
								</govuk-summary-list-row-value>
							</govuk-summary-list-row>
						</govuk-summary-list>
					</div>
				}
			}
		</div>
	
	</form>
</div>